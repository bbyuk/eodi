name: Backend - Deploy (Compose)

on:
  # 단독 수동 배포 (롤백 / 재배포용)
  workflow_dispatch:
    inputs:
      image_tag:
        description: "ECR image tag to deploy (e.g. 20260107-2230-a1b2c3d)"
        required: true

  # orchestration에서 호출 가능
  workflow_call:
    inputs:
      image_tag:
        required: true
        type: string
    secrets:
      AWS_REGION:
        required: true
      AWS_IAM_ROLE:
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_IAM_ROLE: ${{ secrets.AWS_IAM_ROLE }}

jobs:
  deploy:
    name: Deploy Backend API
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # AWS OIDC 인증
      # ------------------------
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      # ------------------------
      # EC2 (SSM)에서 compose 재기동
      # ------------------------
      - name: Deploy backend via SSM
        id: ssm
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets \
              "Key=tag:project,Values=eodi" \
              "Key=tag:phase,Values=prod" \
              "Key=tag:role,Values=app" \
            --parameters 'commands=[
              "cd /opt/eodi/infra/prod/app/compose",
              "echo \"[DEPLOY] backend image tag: '"$IMAGE_TAG"'\"",
              "export EODI_API_TAG='"$IMAGE_TAG"'",
              "docker compose -f docker-compose.api.yml pull",
              "docker compose -f docker-compose.api.yml up -d"
            ]' \
            --query 'Command.CommandId' \
            --output text)

          echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_ENV
          echo "SSM CommandId = $COMMAND_ID"
      - name: Wait & fetch SSM result
        run: |
          sleep 5
          aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --details \
            --region "$AWS_REGION"

